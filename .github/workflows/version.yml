name: Semantic Version

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest_tag
        run: |
          # Récupérer le dernier tag ou utiliser v0.0.0 si aucun
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Latest tag: ${LATEST_TAG}"

      - name: Calculate next version
        id: next_version
        run: |
          LATEST_TAG="${{ steps.latest_tag.outputs.tag }}"
          # Extraire major.minor.patch
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Analyser les commits depuis le dernier tag
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --oneline)
          else
            COMMITS=$(git log ${LATEST_TAG}..HEAD --oneline)
          fi

          echo "Commits since ${LATEST_TAG}:"
          echo "$COMMITS"

          # Pas de nouveaux commits = pas de release
          if [ -z "$COMMITS" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No new commits, skipping release"
            exit 0
          fi

          # Déterminer le type de bump selon semantic versioning
          # BREAKING CHANGE ou feat!: -> major
          # feat: -> minor
          # fix:, perf:, refactor: -> patch

          BUMP="patch"

          if echo "$COMMITS" | grep -qiE "(BREAKING CHANGE|!:)"; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qiE "^[a-f0-9]+ feat(\(|:)"; then
            BUMP="minor"
          fi

          # Calculer la nouvelle version
          case $BUMP in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Bump type: ${BUMP}"
          echo "New version: ${NEW_VERSION}"

      - name: Create and push tag
        if: steps.next_version.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.next_version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${VERSION}" -m "Release ${VERSION}"
          git push origin "${VERSION}"
          echo "Created and pushed tag: ${VERSION}"
