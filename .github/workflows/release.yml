# Semantic Release Workflow
# Automatically creates releases based on conventional commits
#
# Commit types:
#   feat: -> Minor version bump (0.1.0 -> 0.2.0)
#   fix:  -> Patch version bump (0.1.0 -> 0.1.1)
#   perf: -> Patch version bump
#   BREAKING CHANGE: -> Major version bump (0.1.0 -> 1.0.0)

name: Semantic Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    concurrency: release

    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install semantic-release
        run: pip install python-semantic-release>=9.0.0

      - name: Python Semantic Release
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run semantic-release version to determine and bump version
          OUTPUT=$(semantic-release version --print 2>&1) || true
          echo "Semantic release output: $OUTPUT"

          # Check if a new version was released
          if semantic-release version 2>&1 | grep -q "No release will be made"; then
            echo "released=false" >> $GITHUB_OUTPUT
            echo "No new release needed"
          else
            # Get the new version
            VERSION=$(grep -oP '__version__ = "\K[^"]+' lele/__init__.py)
            echo "released=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=v$VERSION" >> $GITHUB_OUTPUT
            echo "New version: $VERSION"

            # Push changes and tag
            git push origin main --follow-tags
          fi

      - name: Create GitHub Release
        if: steps.release.outputs.released == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Generate changelog for this release
          semantic-release changelog --post

          # Create GitHub release
          gh release create "v${{ steps.release.outputs.version }}" \
            --title "Lele v${{ steps.release.outputs.version }}" \
            --generate-notes \
            --latest

  # Trigger Windows builds after release
  trigger-builds:
    name: Trigger Windows Builds
    needs: release
    if: needs.release.outputs.released == 'true'
    uses: ./.github/workflows/build-windows.yml
    with:
      version: ${{ needs.release.outputs.version }}
      upload-to-release: true
    secrets: inherit
